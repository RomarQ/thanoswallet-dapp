{"version":3,"file":"index.module.js","sources":["../src/types.ts","../src/client.ts"],"sourcesContent":["export type ThanosDAppMessage = ThanosDAppRequest | ThanosDAppResponse;\n\nexport type ThanosDAppRequest =\n  | ThanosDAppPermissionRequest\n  | ThanosDAppOperationRequest;\n\nexport type ThanosDAppResponse =\n  | ThanosDAppPermissionResponse\n  | ThanosDAppOperationResponse;\n\nexport interface ThanosDAppMessageBase {\n  type: ThanosDAppMessageType;\n}\n\nexport enum ThanosDAppMessageType {\n  PermissionRequest = \"PERMISSION_REQUEST\",\n  PermissionResponse = \"PERMISSION_RESPONSE\",\n  OperationRequest = \"OPERATION_REQUEST\",\n  OperationResponse = \"OPERATION_RESPONSE\",\n}\n\n/**\n * Messages\n */\n\nexport interface ThanosDAppPermissionRequest extends ThanosDAppMessageBase {\n  type: ThanosDAppMessageType.PermissionRequest;\n  network: ThanosDAppNetwork;\n  appMeta: ThanosDAppMetadata;\n  force?: boolean;\n}\n\nexport interface ThanosDAppPermissionResponse extends ThanosDAppMessageBase {\n  type: ThanosDAppMessageType.PermissionResponse;\n  pkh: string;\n  rpc: string;\n}\n\nexport interface ThanosDAppOperationRequest extends ThanosDAppMessageBase {\n  type: ThanosDAppMessageType.OperationRequest;\n  sourcePkh: string;\n  opParams: any[];\n}\n\nexport interface ThanosDAppOperationResponse extends ThanosDAppMessageBase {\n  type: ThanosDAppMessageType.OperationResponse;\n  opHash: string;\n}\n\n/**\n * Errors\n */\nexport enum ThanosDAppErrorType {\n  NotGranted = \"NOT_GRANTED\",\n  NotFound = \"NOT_FOUND\",\n  InvalidParams = \"INVALID_PARAMS\",\n}\n\n/**\n * Misc\n */\n\nexport type ThanosDAppNetwork = \"mainnet\" | \"carthagenet\";\n\nexport interface ThanosDAppMetadata {\n  name: string;\n}\n\nexport interface ThanosPageMessage {\n  type: ThanosPageMessageType;\n  payload: any;\n  reqId?: string | number;\n}\n\nexport enum ThanosPageMessageType {\n  Request = \"THANOS_PAGE_REQUEST\",\n  Response = \"THANOS_PAGE_RESPONSE\",\n  ErrorResponse = \"THANOS_PAGE_ERROR_RESPONSE\",\n}\n","import { nanoid } from \"nanoid\";\nimport {\n  ThanosPageMessageType,\n  ThanosPageMessage,\n  ThanosDAppMessageType,\n  ThanosDAppRequest,\n  ThanosDAppResponse,\n  ThanosDAppErrorType,\n  ThanosDAppNetwork,\n  ThanosDAppMetadata,\n} from \"./types\";\n\nexport function isAvailable() {\n  return new Promise<boolean>((resolve) => {\n    const handleMessage = (evt: MessageEvent) => {\n      if (\n        evt.source === window &&\n        evt.data?.type === ThanosPageMessageType.Response &&\n        evt.data?.payload === \"PONG\"\n      ) {\n        done(true);\n      }\n    };\n\n    const done = (result: boolean) => {\n      resolve(result);\n      window.removeEventListener(\"message\", handleMessage);\n      clearTimeout(t);\n    };\n\n    send({\n      type: ThanosPageMessageType.Request,\n      payload: \"PING\",\n    });\n    window.addEventListener(\"message\", handleMessage);\n    const t = setTimeout(() => done(false), 100);\n  });\n}\n\nexport function onAvailabilityChange(callback: (available: boolean) => void) {\n  let t: any;\n  let currentStatus = false;\n  const check = async (attempt = 0) => {\n    const initial = attempt < 5;\n    const available = await isAvailable();\n    if (currentStatus !== available) {\n      callback(available);\n      currentStatus = available;\n    }\n    t = setTimeout(\n      check,\n      available ? 10_000 : !initial ? 5_000 : 250,\n      initial ? attempt + 1 : attempt\n    );\n  };\n  check();\n  return () => clearTimeout(t);\n}\n\nexport async function requestPermission(\n  network: ThanosDAppNetwork,\n  appMeta: ThanosDAppMetadata,\n  force: boolean\n) {\n  const res = await request({\n    type: ThanosDAppMessageType.PermissionRequest,\n    network,\n    appMeta,\n    force,\n  });\n  assertResponse(res.type === ThanosDAppMessageType.PermissionResponse);\n  return { pkh: res.pkh, rpc: res.rpc };\n}\n\nexport async function requestOperation(sourcePkh: string, opParams: any) {\n  const res = await request({\n    type: ThanosDAppMessageType.OperationRequest,\n    sourcePkh,\n    opParams,\n  });\n  assertResponse(res.type === ThanosDAppMessageType.OperationResponse);\n  return res.opHash;\n}\n\nfunction request(payload: ThanosDAppRequest) {\n  return new Promise<ThanosDAppResponse>((resolve, reject) => {\n    const reqId = nanoid();\n    const handleMessage = (evt: MessageEvent) => {\n      const res = evt.data as ThanosPageMessage;\n      switch (true) {\n        case evt.source !== window || res?.reqId !== reqId:\n          return;\n\n        case res?.type === ThanosPageMessageType.Response:\n          resolve(res.payload);\n          window.removeEventListener(\"message\", handleMessage);\n          break;\n\n        case res?.type === ThanosPageMessageType.ErrorResponse:\n          reject(createError(res.payload));\n          window.removeEventListener(\"message\", handleMessage);\n          break;\n      }\n    };\n\n    send({\n      type: ThanosPageMessageType.Request,\n      payload,\n      reqId,\n    });\n\n    window.addEventListener(\"message\", handleMessage);\n  });\n}\n\nfunction createError(payload: any) {\n  switch (payload) {\n    case ThanosDAppErrorType.NotGranted:\n      return new NotGrantedThanosWalletError();\n\n    case ThanosDAppErrorType.NotFound:\n      return new NotFoundThanosWalletError();\n\n    case ThanosDAppErrorType.InvalidParams:\n      return new InvalidParamsThanosWalletError();\n\n    default:\n      return new ThanosWalletError();\n  }\n}\n\nfunction assertResponse(condition: any): asserts condition {\n  if (!condition) {\n    throw new Error(\"Invalid response recieved\");\n  }\n}\n\nfunction send(msg: ThanosPageMessage) {\n  window.postMessage(msg, \"*\");\n}\n\nexport class ThanosWalletError implements Error {\n  name = \"ThanosWalletError\";\n  message = \"An unknown error occured. Please try again or report it\";\n}\n\nexport class NotConnectedThanosWalletError extends ThanosWalletError {\n  name = \"ThanosWalletNotConnected\";\n  message =\n    \"You need to connect ThanosWallet by calling thanosWallet.connect() first\";\n}\n\nexport class NotGrantedThanosWalletError extends ThanosWalletError {\n  name = \"NotGrantedThanosWalletError\";\n  message = \"Permission Not Granted\";\n}\n\nexport class NotFoundThanosWalletError extends ThanosWalletError {\n  name = \"NotFoundThanosWalletError\";\n  message = \"Account Not Found. Try connect again\";\n}\n\nexport class InvalidParamsThanosWalletError extends ThanosWalletError {\n  name = \"InvalidParamsThanosWalletError\";\n  message = \"Some of the parameters you provided are invalid\";\n}\n"],"names":["ThanosDAppMessageType","ThanosDAppErrorType","ThanosPageMessageType","requestOperation","sourcePkh","opParams","request","type","OperationRequest","res","assertResponse","OperationResponse","opHash","requestPermission","network","appMeta","force","PermissionRequest","PermissionResponse","pkh","rpc","isAvailable","Promise","resolve","handleMessage","evt","source","window","data","Response","payload","done","result","removeEventListener","clearTimeout","t","send","Request","addEventListener","setTimeout","onAvailabilityChange","callback","currentStatus","check","attempt","initial","available","reject","reqId","nanoid","ErrorResponse","NotGranted","NotGrantedThanosWalletError","NotFound","NotFoundThanosWalletError","InvalidParams","InvalidParamsThanosWalletError","ThanosWalletError","createError","condition","Error","msg","postMessage","this","NotConnectedThanosWalletError","_this","_this2","_this3","_this4"],"mappings":"gCAcYA,IAAAA,EAsCAC,EAsBAC,kGA5DZ,SAAYF,GACVA,yCACAA,2CACAA,uCACAA,yCAJF,CAAYA,IAAAA,OAsCZ,SAAYC,GACVA,2BACAA,uBACAA,iCAHF,CAAYA,IAAAA,OAsBZ,SAAYC,GACVA,gCACAA,kCACAA,6CAHF,CAAYA,IAAAA,OCAUC,IAAAA,WAAiBC,EAAmBC,8BACtCC,EAAQ,CACxBC,KAAMP,EAAsBQ,iBAC5BJ,UAAAA,EACAC,SAAAA,mBAHII,GAMN,OADAC,EAAeD,EAAIF,OAASP,EAAsBW,mBAC3CF,EAAIG,SAPb,oCAfsBC,WACpBC,EACAC,EACAC,8BAEkBV,EAAQ,CACxBC,KAAMP,EAAsBiB,kBAC5BH,QAAAA,EACAC,QAAAA,EACAC,MAAAA,mBAJIP,GAON,OADAC,EAAeD,EAAIF,OAASP,EAAsBkB,oBAC3C,CAAEC,IAAKV,EAAIU,IAAKC,IAAKX,EAAIW,OAZlC,6CA/CgBC,IACd,WAAWC,QAAiB,SAACC,GAC3B,IAAMC,EAAgB,SAACC,WAEnBA,EAAIC,SAAWC,mBACfF,EAAIG,2BAAMrB,QAASL,EAAsB2B,UACnB,oBAAtBJ,EAAIG,2BAAME,UAEVC,GAAK,IAIHA,EAAO,SAACC,GACZT,EAAQS,GACRL,OAAOM,oBAAoB,UAAWT,GACtCU,aAAaC,IAGfC,EAAK,CACH7B,KAAML,EAAsBmC,QAC5BP,QAAS,SAEXH,OAAOW,iBAAiB,UAAWd,GACnC,IAAMW,EAAII,WAAW,kBAAMR,GAAK,IAAQ,OAI5C,SAAgBS,EAAqBC,GACnC,IAAIN,EACAO,GAAgB,EAepB,gBAdMC,EAAeC,YAAAA,IAAAA,EAAU,OAC7B,IAAMC,EAAUD,EAAU,yBACFvB,mBAAlByB,GACFJ,IAAkBI,IACpBL,EAASK,GACTJ,EAAgBI,GAElBX,EAAII,WACFI,EACAG,EAAY,IAAUD,EAAkB,IAAR,IAChCA,EAAUD,EAAU,EAAIA,KAVjB,mCAaXD,qBACaT,aAAaC,IA4B5B,SAAS7B,EAAQwB,GACf,WAAWR,QAA4B,SAACC,EAASwB,GAC/C,IAAMC,EAAQC,IAmBdb,EAAK,CACH7B,KAAML,EAAsBmC,QAC5BP,QAAAA,EACAkB,MAAAA,IAGFrB,OAAOW,iBAAiB,UAxBF,SAAhBd,EAAiBC,GACrB,IAAMhB,EAAMgB,EAAIG,KAChB,QAAQ,GACN,KAAKH,EAAIC,SAAWC,SAAUlB,MAAAA,SAAAA,EAAKuC,SAAUA,EAC3C,OAEF,KAAKvC,MAAAA,SAAAA,EAAKF,QAASL,EAAsB2B,SACvCN,EAAQd,EAAIqB,SACZH,OAAOM,oBAAoB,UAAWT,GACtC,MAEF,KAAKf,MAAAA,SAAAA,EAAKF,QAASL,EAAsBgD,cACvCH,EAgBV,SAAqBjB,GACnB,OAAQA,GACN,KAAK7B,EAAoBkD,WACvB,WAAWC,EAEb,KAAKnD,EAAoBoD,SACvB,WAAWC,EAEb,KAAKrD,EAAoBsD,cACvB,WAAWC,EAEb,QACE,WAAWC,GA5BAC,CAAYjD,EAAIqB,UACvBH,OAAOM,oBAAoB,UAAWT,QA+BhD,SAASd,EAAeiD,GACtB,IAAKA,EACH,UAAUC,MAAM,6BAIpB,SAASxB,EAAKyB,GACZlC,OAAOmC,YAAYD,EAAK,KAGbJ,IAAAA,EAAb,WACEM,UAAO,oBACPA,aAAU,2DAGCC,cAAb,gEACS,2BACPC,UACE,6EAHJ,iBAAmDR,GAMtCL,cAAb,gEACS,8BACPc,UAAU,2BAFZ,iBAAiDT,GAKpCH,cAAb,gEACS,4BACPa,UAAU,yCAFZ,iBAA+CV,GAKlCD,cAAb,gEACS,iCACPY,UAAU,oDAFZ,iBAAoDX"}